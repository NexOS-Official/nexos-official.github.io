<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>NexOS - Eclipse Chat</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Google+Sans:wght@400;500;600&family=Roboto:wght@400;500&display=swap" rel="stylesheet">
  <script src="https://cdn.scaledrone.com/scaledrone.min.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --primary: #1a73e8;
      --primary-light: #e8f0fe;
      --bg: #ffffff;
      --bg-secondary: #f8f9fa;
      --text: #202124;
      --text-secondary: #5f6368;
      --border: #e0e0e0;
      --green: #34a853;
      --surface: #ffffff;
    }

    body {
      font-family: 'Roboto', -apple-system, BlinkMacSystemFont, sans-serif;
      background: var(--bg-secondary);
      color: var(--text);
      height: 100vh;
      overflow: hidden;
    }

    /* Login Screen */
    .login-screen {
      display: flex;
      align-items: center;
      justify-content: center;
      height: 100vh;
      background: linear-gradient(135deg, #f5f7fa 0%, #e4e8ec 100%);
    }

    .login-card {
      background: var(--surface);
      border-radius: 28px;
      padding: 48px;
      width: 100%;
      max-width: 420px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.08), 0 8px 24px rgba(0,0,0,0.08);
    }

    .login-card h1 {
      font-family: 'Google Sans', sans-serif;
      font-size: 28px;
      font-weight: 400;
      color: var(--text);
      margin-bottom: 8px;
      text-align: center;
    }

    .login-card p {
      color: var(--text-secondary);
      text-align: center;
      margin-bottom: 32px;
      font-size: 14px;
    }

    .login-card input {
      width: 100%;
      padding: 16px;
      border: 1px solid var(--border);
      border-radius: 8px;
      font-size: 16px;
      margin-bottom: 20px;
      transition: border-color 0.2s, box-shadow 0.2s;
      outline: none;
    }

    .login-card input:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 2px var(--primary-light);
    }

    .login-card button {
      width: 100%;
      padding: 14px 24px;
      background: var(--primary);
      color: white;
      border: none;
      border-radius: 24px;
      font-size: 15px;
      font-weight: 500;
      cursor: pointer;
      transition: background 0.2s, box-shadow 0.2s;
    }

    .login-card button:hover {
      background: #1557b0;
      box-shadow: 0 1px 3px rgba(26,115,232,0.3);
    }

    /* Main Chat Layout */
    .chat-app {
      display: none;
      height: 100vh;
    }

    .chat-app.active {
      display: flex;
    }

    /* Sidebar */
    .sidebar {
      width: 320px;
      background: var(--surface);
      border-right: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      flex-shrink: 0;
    }

    .sidebar-header {
      padding: 16px 20px;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .sidebar-header h2 {
      font-family: 'Google Sans', sans-serif;
      font-size: 22px;
      font-weight: 400;
      color: var(--text);
    }

    .header-actions {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .icon-btn {
      width: 36px;
      height: 36px;
      border: none;
      background: transparent;
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--text-secondary);
      transition: background 0.15s;
    }

    .icon-btn:hover {
      background: var(--bg-secondary);
    }

    .icon-btn svg {
      width: 20px;
      height: 20px;
    }

    .user-info {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 4px 12px;
      background: var(--bg-secondary);
      border-radius: 20px;
      font-size: 13px;
      color: var(--text-secondary);
    }

    .user-avatar-small {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 11px;
      font-weight: 500;
      color: white;
    }

    /* Chat sections */
    .chat-section {
      padding: 8px 12px;
    }

    .chat-section-title {
      font-size: 11px;
      font-weight: 500;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      padding: 8px 8px 4px;
    }

    .chat-list {
      flex: 1;
      overflow-y: auto;
    }

    .chat-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 10px 12px;
      cursor: pointer;
      transition: background 0.15s;
      border-radius: 12px;
      margin: 2px 8px;
    }

    .chat-item:hover {
      background: var(--bg-secondary);
    }

    .chat-item.active {
      background: var(--primary-light);
    }

    .chat-item-avatar {
      width: 44px;
      height: 44px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      font-weight: 500;
      color: white;
      flex-shrink: 0;
    }

    .chat-item-content {
      flex: 1;
      min-width: 0;
    }

    .chat-item-name {
      font-weight: 500;
      color: var(--text);
      font-size: 14px;
      margin-bottom: 2px;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .badge {
      font-size: 10px;
      padding: 2px 6px;
      border-radius: 4px;
      font-weight: 500;
    }

    .badge-dm {
      background: #fce8e6;
      color: #c5221f;
    }

    .badge-group {
      background: #e6f4ea;
      color: #137333;
    }

    .badge-room {
      background: #fef7e0;
      color: #b06000;
    }

    .chat-item-preview {
      color: var(--text-secondary);
      font-size: 13px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .unread-badge {
      background: var(--primary);
      color: white;
      font-size: 11px;
      font-weight: 500;
      padding: 2px 7px;
      border-radius: 10px;
      min-width: 20px;
      text-align: center;
    }

    /* Main Chat Area */
    .chat-main {
      flex: 1;
      display: flex;
      flex-direction: column;
      background: var(--bg-secondary);
    }

    .chat-header {
      background: var(--surface);
      padding: 12px 24px;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .chat-header-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      font-weight: 500;
      color: white;
    }

    .chat-header-info {
      flex: 1;
    }

    .chat-header-info h3 {
      font-family: 'Google Sans', sans-serif;
      font-size: 16px;
      font-weight: 500;
      color: var(--text);
    }

    .chat-header-info p {
      font-size: 12px;
      color: var(--text-secondary);
    }

    /* Messages */
    .messages-container {
      flex: 1;
      overflow-y: auto;
      padding: 16px 24px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .message {
      display: flex;
      gap: 8px;
      max-width: 70%;
      animation: messageIn 0.2s ease-out;
    }

    @keyframes messageIn {
      from { opacity: 0; transform: translateY(8px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .message.self {
      align-self: flex-end;
      flex-direction: row-reverse;
    }

    .message-avatar {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      font-weight: 500;
      color: white;
      flex-shrink: 0;
      align-self: flex-end;
    }

    .message.self .message-avatar {
      display: none;
    }

    .message-content {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .message-sender {
      font-size: 12px;
      font-weight: 500;
      color: var(--text-secondary);
      margin-left: 12px;
    }

    .message.self .message-sender {
      display: none;
    }

    .message-bubble {
      padding: 10px 14px;
      border-radius: 20px;
      font-size: 14px;
      line-height: 1.4;
      word-wrap: break-word;
    }

    .message:not(.self) .message-bubble {
      background: var(--surface);
      color: var(--text);
      border-bottom-left-radius: 4px;
      box-shadow: 0 1px 2px rgba(0,0,0,0.06);
    }

    .message.self .message-bubble {
      background: var(--primary);
      color: white;
      border-bottom-right-radius: 4px;
    }

    .message-time {
      font-size: 11px;
      color: var(--text-secondary);
      margin-left: 12px;
    }

    .message.self .message-time {
      text-align: right;
      margin-right: 4px;
      margin-left: 0;
    }

    .system-message {
      text-align: center;
      padding: 8px;
    }

    .system-message span {
      background: var(--surface);
      color: var(--text-secondary);
      font-size: 12px;
      padding: 6px 16px;
      border-radius: 16px;
      border: 1px solid var(--border);
    }

    /* Message Input */
    .message-input-container {
      background: var(--surface);
      padding: 12px 24px;
      border-top: 1px solid var(--border);
    }

    .message-input-wrapper {
      display: flex;
      align-items: center;
      gap: 12px;
      background: var(--bg-secondary);
      border-radius: 24px;
      padding: 4px 4px 4px 16px;
    }

    .message-input-wrapper input {
      flex: 1;
      border: none;
      background: transparent;
      font-size: 14px;
      padding: 8px 0;
      outline: none;
      color: var(--text);
    }

    .send-btn {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      border: none;
      background: var(--primary);
      color: white;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.2s, transform 0.1s;
    }

    .send-btn:hover {
      background: #1557b0;
    }

    .send-btn:active {
      transform: scale(0.95);
    }

    .send-btn svg {
      width: 20px;
      height: 20px;
    }

    /* Context Menu */
    .context-menu {
      position: fixed;
      background: var(--surface);
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.15), 0 0 1px rgba(0,0,0,0.1);
      padding: 8px 0;
      min-width: 180px;
      z-index: 1000;
      display: none;
    }

    .context-menu.show {
      display: block;
      animation: menuIn 0.15s ease-out;
    }

    @keyframes menuIn {
      from { opacity: 0; transform: scale(0.95); }
      to { opacity: 1; transform: scale(1); }
    }

    .context-menu-item {
      padding: 10px 16px;
      font-size: 14px;
      color: var(--text);
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 12px;
      transition: background 0.1s;
    }

    .context-menu-item:hover {
      background: var(--bg-secondary);
    }

    .context-menu-item svg {
      width: 18px;
      height: 18px;
      color: var(--text-secondary);
    }

    /* Added styles for sidebar context menu */
    .context-menu-divider {
      height: 1px;
      background: var(--border);
      margin: 4px 0;
    }

    .context-menu-item.danger {
      color: #c5221f;
    }

    .context-menu-item.danger svg {
      color: #c5221f;
    }

    /* Modal */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.3);
      z-index: 1999;
      display: none;
    }

    .modal-overlay.show {
      display: block;
    }

    .modal {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: var(--surface);
      border-radius: 16px;
      box-shadow: 0 4px 24px rgba(0,0,0,0.15);
      padding: 24px;
      z-index: 2000;
      min-width: 360px;
      max-width: 90vw;
      display: none;
      animation: modalIn 0.2s ease-out;
    }

    .modal.show {
      display: block;
    }

    @keyframes modalIn {
      from { opacity: 0; transform: translate(-50%, -50%) scale(0.95); }
      to { opacity: 1; transform: translate(-50%, -50%) scale(1); }
    }

    .modal h3 {
      font-family: 'Google Sans', sans-serif;
      font-size: 20px;
      font-weight: 500;
      color: var(--text);
      margin-bottom: 16px;
    }

    .modal p {
      color: var(--text-secondary);
      font-size: 14px;
      margin-bottom: 16px;
    }

    .modal label {
      display: block;
      font-size: 13px;
      font-weight: 500;
      color: var(--text-secondary);
      margin-bottom: 6px;
    }

    .modal input {
      width: 100%;
      padding: 12px;
      border: 1px solid var(--border);
      border-radius: 8px;
      font-size: 14px;
      margin-bottom: 16px;
      outline: none;
    }

    .modal input:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 2px var(--primary-light);
    }

    .modal-buttons {
      display: flex;
      gap: 12px;
      justify-content: flex-end;
    }

    .modal-btn {
      padding: 10px 20px;
      border: none;
      border-radius: 20px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: background 0.2s;
    }

    .modal-btn-primary {
      background: var(--primary);
      color: white;
    }

    .modal-btn-primary:hover {
      background: #1557b0;
    }

    .modal-btn-secondary {
      background: var(--bg-secondary);
      color: var(--text);
    }

    .modal-btn-secondary:hover {
      background: #e8eaed;
    }

    /* Member tags for group creation */
    .member-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 16px;
      min-height: 32px;
    }

    .member-tag {
      display: flex;
      align-items: center;
      gap: 6px;
      background: var(--primary-light);
      color: var(--primary);
      padding: 4px 10px;
      border-radius: 16px;
      font-size: 13px;
      font-weight: 500;
    }

    .member-tag button {
      background: none;
      border: none;
      color: var(--primary);
      cursor: pointer;
      font-size: 16px;
      line-height: 1;
      padding: 0;
      display: flex;
      align-items: center;
    }

    .member-tag button:hover {
      color: #1557b0;
    }

    /* Toast */
    .toast {
      position: fixed;
      bottom: 24px;
      left: 50%;
      transform: translateX(-50%);
      background: #323232;
      color: white;
      border-radius: 8px;
      padding: 12px 24px;
      font-size: 14px;
      z-index: 3000;
      animation: toastIn 0.3s ease-out;
    }

    @keyframes toastIn {
      from { opacity: 0; transform: translate(-50%, 10px); }
      to { opacity: 1; transform: translate(-50%, 0); }
    }

    /* Empty State */
    .empty-state {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100%;
      color: var(--text-secondary);
    }

    .empty-state svg {
      width: 64px;
      height: 64px;
      margin-bottom: 16px;
      opacity: 0.4;
    }

    .empty-state h3 {
      font-family: 'Google Sans', sans-serif;
      font-size: 18px;
      font-weight: 400;
      margin-bottom: 4px;
      color: var(--text);
    }

    .empty-state p {
      font-size: 14px;
    }

    /* Scrollbar */
    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: #dadce0; border-radius: 3px; }
    ::-webkit-scrollbar-thumb:hover { background: #bdc1c6; }

    /* Mobile */
    @media (max-width: 768px) {
      .sidebar {
        width: 100%;
        position: absolute;
        z-index: 10;
        height: 100%;
      }
      .sidebar.hidden { display: none; }
      .chat-main { width: 100%; }
      .back-btn { display: flex; }
    }

    .back-btn {
      display: none;
      width: 36px;
      height: 36px;
      border: none;
      background: transparent;
      cursor: pointer;
      border-radius: 50%;
      align-items: center;
      justify-content: center;
      color: var(--text-secondary);
      transition: background 0.15s;
    }

    .back-btn:hover {
      background: var(--bg-secondary);
    }
  </style>
</head>
<body>
  <!-- Login Screen -->
  <div class="login-screen" id="loginScreen">
    <div class="login-card">
      <h1>Welcome to NexOS</h1>
      <p>Enter a display name to start chatting</p>
      <form id="loginForm">
        <input type="text" id="usernameInput" placeholder="Your display name" maxlength="20" autocomplete="off" required>
        <button type="submit">Continue</button>
      </form>
    </div>
  </div>

  <!-- Main Chat App -->
  <div class="chat-app" id="chatApp">
    <!-- Sidebar -->
    <div class="sidebar" id="sidebar">
      <div class="sidebar-header">
        <h2>Chats</h2>
        <div class="header-actions">
          <button class="icon-btn" id="newGroupBtn" title="Create group chat">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
              <circle cx="9" cy="7" r="4"/>
              <path d="M23 21v-2a4 4 0 0 0-3-3.87M16 3.13a4 4 0 0 1 0 7.75"/>
            </svg>
          </button>
          <button class="icon-btn" id="newRoomBtn" title="Create private room">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <rect x="3" y="11" width="18" height="11" rx="2" ry="2"/>
              <path d="M7 11V7a5 5 0 0 1 10 0v4"/>
            </svg>
          </button>
          <button class="icon-btn" id="joinRoomBtn" title="Join room/group">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4M10 17l5-5-5-5M15 12H3"/>
            </svg>
          </button>
        </div>
      </div>
      <div class="chat-list" id="chatList"></div>
    </div>

    <!-- Main Chat Area -->
    <div class="chat-main">
      <div class="chat-header" id="chatHeader">
        <button class="back-btn" id="backBtn">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M19 12H5M12 19l-7-7 7-7"/>
          </svg>
        </button>
        <div class="chat-header-avatar" id="chatAvatar"></div>
        <div class="chat-header-info">
          <h3 id="chatTitle">Public Chat</h3>
          <p id="chatSubtitle">Everyone can see these messages</p>
        </div>
        <button class="icon-btn" id="copyRoomCodeBtn" title="Copy room code" style="display: none;">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <rect x="9" y="9" width="13" height="13" rx="2" ry="2"/>
            <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/>
          </svg>
        </button>
      </div>

      <div class="messages-container" id="messagesContainer"></div>

      <div class="message-input-container">
        <form class="message-input-wrapper" id="messageForm">
          <input type="text" id="messageInput" placeholder="Type a message" autocomplete="off">
          <button type="submit" class="send-btn">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z"/>
            </svg>
          </button>
        </form>
      </div>
    </div>
  </div>

  <!-- Context Menu for Messages -->
  <div class="context-menu" id="contextMenu">
    <div class="context-menu-item" id="dmMenuItem">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
      </svg>
      <span>Send direct message</span>
    </div>
  </div>

  <!-- Added context menu for sidebar chat items -->
  <div class="context-menu" id="chatContextMenu">
    <div class="context-menu-item" id="renameChatItem">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
        <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
      </svg>
      <span>Rename chat</span>
    </div>
    <div class="context-menu-divider"></div>
    <div class="context-menu-item danger" id="leaveChatItem">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/>
        <polyline points="16 17 21 12 16 7"/>
        <line x1="21" y1="12" x2="9" y2="12"/>
      </svg>
      <span>Leave chat</span>
    </div>
  </div>

  <!-- Modal Overlay -->
  <div class="modal-overlay" id="modalOverlay"></div>

  <!-- Create Group Modal -->
  <div class="modal" id="createGroupModal">
    <h3>Create Group Chat</h3>
    <label>Group Name</label>
    <input type="text" id="groupNameInput" placeholder="Enter group name" maxlength="30">
    <label>Invite Members (by display name)</label>
    <div class="member-tags" id="memberTags"></div>
    <input type="text" id="memberInput" placeholder="Type a name and press Enter">
    <div class="modal-buttons">
      <button class="modal-btn modal-btn-secondary" onclick="closeModal()">Cancel</button>
      <button class="modal-btn modal-btn-primary" id="createGroupConfirm">Create & Invite</button>
    </div>
  </div>

  <!-- Create Room Modal -->
  <div class="modal" id="createRoomModal">
    <h3>Create Private Room</h3>
    <p>A unique code will be generated that you can share with others to join.</p>
    <label>Room Name</label>
    <input type="text" id="roomNameInput" placeholder="Enter room name" maxlength="30">
    <div class="modal-buttons">
      <button class="modal-btn modal-btn-secondary" onclick="closeModal()">Cancel</button>
      <button class="modal-btn modal-btn-primary" id="createRoomConfirm">Create</button>
    </div>
  </div>

  <!-- Join Room Modal -->
  <div class="modal" id="joinRoomModal">
    <h3>Join Room or Group</h3>
    <p>Enter the code shared with you to join.</p>
    <label>Room/Group Code</label>
    <input type="text" id="joinRoomCodeInput" placeholder="Paste code here">
    <div class="modal-buttons">
      <button class="modal-btn modal-btn-secondary" onclick="closeModal()">Cancel</button>
      <button class="modal-btn modal-btn-primary" id="joinRoomConfirm">Join</button>
    </div>
  </div>

  <!-- DM Invitation Modal -->
  <div class="modal" id="dmInviteModal">
    <h3>Direct Message Request</h3>
    <p id="dmInviteText"></p>
    <div class="modal-buttons">
      <button class="modal-btn modal-btn-secondary" id="dmDeclineBtn">Decline</button>
      <button class="modal-btn modal-btn-primary" id="dmAcceptBtn">Accept</button>
    </div>
  </div>

  <!-- Group Invitation Modal -->
  <div class="modal" id="groupInviteModal">
    <h3>Group Chat Invitation</h3>
    <p id="groupInviteText"></p>
    <div class="modal-buttons">
      <button class="modal-btn modal-btn-secondary" id="groupDeclineBtn">Decline</button>
      <button class="modal-btn modal-btn-primary" id="groupAcceptBtn">Join Group</button>
    </div>
  </div>

  <!-- Added rename modal -->
  <div class="modal" id="renameChatModal">
    <h3>Rename Chat</h3>
    <label>Display Name (only you will see this)</label>
    <input type="text" id="renameChatInput" placeholder="Enter new name" maxlength="30">
    <div class="modal-buttons">
      <button class="modal-btn modal-btn-secondary" onclick="closeModal()">Cancel</button>
      <button class="modal-btn modal-btn-primary" id="renameChatConfirm">Rename</button>
    </div>
  </div>

  <script>
    const CLIENT_ID = 'aSEKMcR4GsEZONob';
    const PUBLIC_ROOM = 'NexOS';
    const NOTIFICATION_ROOM = 'VplazaNotifications';
    
    let drone;
    let publicRoom;
    let notificationRoom;
    let currentChatRoom;
    let currentUser = '';
    let currentChat = 'public';
    
    let activeRooms = {};
    
    // Chat storage
    let chats = {
      public: { type: 'public', name: 'Public Chat', messages: [] },
    };

    let chatNicknames = {};

    // Pending invitations
    let pendingDMInvite = null;
    let pendingGroupInvite = null;
    
    let groupInviteMembers = [];

    let chatContextTarget = null;

    const COLORS = [
      '#ea4335', '#fbbc04', '#34a853', '#4285f4', '#ab47bc',
      '#00acc1', '#ff7043', '#9e9d24', '#5c6bc0', '#f06292'
    ];

    function getColor(name) {
      let hash = 0;
      for (let i = 0; i < name.length; i++) {
        hash = name.charCodeAt(i) + ((hash << 5) - hash);
      }
      return COLORS[Math.abs(hash) % COLORS.length];
    }

    function getInitials(name) {
      return name.split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2);
    }

    function generateCode(type) {
      const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
      let code = '';
      for (let i = 0; i < 27; i++) {
        code += chars.charAt(Math.floor(Math.random() * chars.length));
      }
      // Add suffix based on type
      if (type === 'room') {
        code += 'ROOM';
      } else if (type === 'group') {
        code += '_GC';
      } else {
        code += '_DM';
      }
      return code;
    }

    function formatTime(date) {
      return new Date(date || Date.now()).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // Storage
    function loadChats() {
      const saved = localStorage.getItem('vplaza_chats');
      if (saved) {
        const parsed = JSON.parse(saved);
        chats = { public: { type: 'public', name: 'Public Chat', messages: [] }, ...parsed };
        if (parsed.public && parsed.public.messages) {
          chats.public.messages = parsed.public.messages;
        }
      }
      const savedNicknames = localStorage.getItem('vplaza_nicknames');
      if (savedNicknames) {
        chatNicknames = JSON.parse(savedNicknames);
      }
    }

    function saveChats() {
      localStorage.setItem('vplaza_chats', JSON.stringify(chats));
    }

    function saveNicknames() {
      localStorage.setItem('vplaza_nicknames', JSON.stringify(chatNicknames));
    }

    function getChatDisplayName(chatId) {
      if (chatNicknames[chatId]) {
        return chatNicknames[chatId];
      }
      const chat = chats[chatId];
      if (!chat) return 'Unknown';
      if (chat.type === 'dm') return chat.partner;
      if (chat.type === 'group') return chat.name;
      if (chat.type === 'room') return chat.name || 'Private Room';
      return chat.name || 'Public Chat';
    }

    // Find existing DM with user
    function findExistingDM(username) {
      for (const [chatId, chat] of Object.entries(chats)) {
        if (chat.type === 'dm' && chat.partner === username) {
          return chatId;
        }
      }
      return null;
    }

    // Toast
    function showToast(message) {
      const existing = document.querySelector('.toast');
      if (existing) existing.remove();
      
      const toast = document.createElement('div');
      toast.className = 'toast';
      toast.textContent = message;
      document.body.appendChild(toast);
      setTimeout(() => {
        toast.style.opacity = '0';
        setTimeout(() => toast.remove(), 300);
      }, 3000);
    }

    // Modal
    function showModal(modalId) {
      document.getElementById('modalOverlay').classList.add('show');
      document.getElementById(modalId).classList.add('show');
    }

    function closeModal() {
      document.getElementById('modalOverlay').classList.remove('show');
      document.querySelectorAll('.modal').forEach(m => m.classList.remove('show'));
      // Reset group members
      groupInviteMembers = [];
      renderMemberTags();
    }

    // Chat List
    function renderChatList() {
      const chatList = document.getElementById('chatList');
      chatList.innerHTML = '';

      // Group chats by type
      const publicChats = [];
      const dmChats = [];
      const groupChats = [];
      const roomChats = [];

      Object.entries(chats).forEach(([id, chat]) => {
        if (id === 'public') publicChats.push({ id, ...chat });
        else if (chat.type === 'dm') dmChats.push({ id, ...chat });
        else if (chat.type === 'group') groupChats.push({ id, ...chat });
        else if (chat.type === 'room') roomChats.push({ id, ...chat });
      });

      // Public section
      publicChats.forEach(chat => {
        chatList.appendChild(createChatItem(chat.id, getChatDisplayName(chat.id), 'ðŸŒ', getLastMessage(chat), null));
      });

      // DMs section
      if (dmChats.length > 0) {
        const section = document.createElement('div');
        section.className = 'chat-section';
        section.innerHTML = '<div class="chat-section-title">Direct Messages</div>';
        chatList.appendChild(section);
        dmChats.forEach(chat => {
          chatList.appendChild(createChatItem(chat.id, getChatDisplayName(chat.id), null, getLastMessage(chat), 'dm'));
        });
      }

      // Groups section
      if (groupChats.length > 0) {
        const section = document.createElement('div');
        section.className = 'chat-section';
        section.innerHTML = '<div class="chat-section-title">Groups</div>';
        chatList.appendChild(section);
        groupChats.forEach(chat => {
          chatList.appendChild(createChatItem(chat.id, getChatDisplayName(chat.id), null, getLastMessage(chat), 'group'));
        });
      }

      // Rooms section
      if (roomChats.length > 0) {
        const section = document.createElement('div');
        section.className = 'chat-section';
        section.innerHTML = '<div class="chat-section-title">Private Rooms</div>';
        chatList.appendChild(section);
        roomChats.forEach(chat => {
          chatList.appendChild(createChatItem(chat.id, getChatDisplayName(chat.id), null, getLastMessage(chat), 'room'));
        });
      }
    }

    function getLastMessage(chat) {
      if (!chat.messages || chat.messages.length === 0) return 'No messages yet';
      const last = chat.messages[chat.messages.length - 1];
      const preview = last.text.slice(0, 30) + (last.text.length > 30 ? '...' : '');
      return last.sender === currentUser ? `You: ${preview}` : preview;
    }

    function createChatItem(id, name, emoji, preview, badgeType) {
      const item = document.createElement('div');
      item.className = 'chat-item' + (currentChat === id ? ' active' : '');
      item.dataset.chatId = id;

      const avatarHtml = emoji 
        ? `<div class="chat-item-avatar" style="background: #e8f0fe; font-size: 22px;">${emoji}</div>`
        : `<div class="chat-item-avatar" style="background: ${getColor(name)}">${getInitials(name)}</div>`;

      let badge = '';
      if (badgeType === 'dm') badge = '<span class="badge badge-dm">DM</span>';
      else if (badgeType === 'group') badge = '<span class="badge badge-group">Group</span>';
      else if (badgeType === 'room') badge = '<span class="badge badge-room">Room</span>';

      item.innerHTML = `
        ${avatarHtml}
        <div class="chat-item-content">
          <div class="chat-item-name">${escapeHtml(name)} ${badge}</div>
          <div class="chat-item-preview">${escapeHtml(preview)}</div>
        </div>
      `;

      item.addEventListener('click', () => switchChat(id));
      
      if (id !== 'public') {
        item.addEventListener('contextmenu', (e) => {
          e.preventDefault();
          chatContextTarget = id;
          showChatContextMenu(e.pageX, e.pageY);
        });
      }
      
      return item;
    }

    function showChatContextMenu(x, y) {
      const menu = document.getElementById('chatContextMenu');
      if (x + 180 > window.innerWidth) x = window.innerWidth - 190;
      if (y + 100 > window.innerHeight) y = window.innerHeight - 110;
      menu.style.left = x + 'px';
      menu.style.top = y + 'px';
      menu.classList.add('show');
    }

    function renameChat() {
      if (!chatContextTarget) return;
      document.getElementById('renameChatInput').value = getChatDisplayName(chatContextTarget);
      document.getElementById('chatContextMenu').classList.remove('show');
      showModal('renameChatModal');
    }

    function confirmRenameChat() {
      if (!chatContextTarget) return;
      const newName = document.getElementById('renameChatInput').value.trim();
      if (newName) {
        chatNicknames[chatContextTarget] = newName;
        saveNicknames();
        renderChatList();
        // Update header if currently viewing this chat
        if (currentChat === chatContextTarget) {
          document.getElementById('chatTitle').textContent = newName;
        }
      }
      closeModal();
      chatContextTarget = null;
    }

    function leaveChat() {
      if (!chatContextTarget || chatContextTarget === 'public') return;
      
      const chatId = chatContextTarget;
      document.getElementById('chatContextMenu').classList.remove('show');
      
      // Remove from active rooms
      if (activeRooms[chatId]) {
        delete activeRooms[chatId];
      }
      
      // Remove from chats
      delete chats[chatId];
      delete chatNicknames[chatId];
      saveChats();
      saveNicknames();
      
      // Switch to public if we were viewing this chat
      if (currentChat === chatId) {
        switchChat('public');
      } else {
        renderChatList();
      }
      
      showToast('Left the chat');
      chatContextTarget = null;
    }

    function subscribeToRoom(roomCode, chatId) {
      if (activeRooms[roomCode]) return activeRooms[roomCode];
      
      const room = drone.subscribe(`observable-${roomCode}`);
      activeRooms[roomCode] = room;

      room.on('error', error => console.error('Room error:', error));

      room.on('data', (data, member) => {
        if (!data) return;

        if (data.type === 'join' && data.name !== currentUser) {
          // Only show join message if viewing this chat
          if (currentChat === chatId) {
            showSystemMessage(`${data.name} joined`);
          }
        } else if (data.text) {
          const isSelf = member.id === drone.clientId;
          
          if (chats[chatId]) {
            chats[chatId].messages.push({
              text: data.text,
              sender: data.name,
              timestamp: data.timestamp
            });
            saveChats();
            renderChatList(); // Update preview in sidebar
          }
          
          // Only add to UI if viewing this chat
          if (currentChat === chatId) {
            addMessageToUI(data.text, data.name, isSelf, data.timestamp);
          }
        }
      });

      return room;
    }

    // Switch Chat
    function switchChat(chatId) {
      currentChat = chatId;
      renderChatList();

      const chatAvatar = document.getElementById('chatAvatar');
      const chatTitle = document.getElementById('chatTitle');
      const chatSubtitle = document.getElementById('chatSubtitle');
      const container = document.getElementById('messagesContainer');
      const copyBtn = document.getElementById('copyRoomCodeBtn');

      container.innerHTML = '';
      copyBtn.style.display = 'none';

      if (chatId === 'public') {
        chatAvatar.style.background = '#e8f0fe';
        chatAvatar.innerHTML = 'ðŸŒ';
        chatAvatar.style.fontSize = '20px';
        chatTitle.textContent = getChatDisplayName('public');
        chatSubtitle.textContent = 'Everyone can see these messages';
        
        // Subscribe to public room
        subscribeToRoom(PUBLIC_ROOM, 'public');
      } else {
        const chat = chats[chatId];
        if (!chat) return;

        const displayName = getChatDisplayName(chatId);

        if (chat.type === 'dm') {
          chatAvatar.style.background = getColor(chat.partner);
          chatAvatar.innerHTML = getInitials(chat.partner);
          chatAvatar.style.fontSize = '16px';
          chatTitle.textContent = displayName;
          chatSubtitle.textContent = 'Private conversation';
        } else if (chat.type === 'group') {
          chatAvatar.style.background = getColor(displayName);
          chatAvatar.innerHTML = getInitials(displayName);
          chatAvatar.style.fontSize = '16px';
          chatTitle.textContent = displayName;
          chatSubtitle.textContent = 'Group chat';
          copyBtn.style.display = 'flex';
          copyBtn.onclick = () => {
            navigator.clipboard.writeText(chatId);
            showToast('Group code copied!');
          };
        } else if (chat.type === 'room') {
          chatAvatar.style.background = getColor(displayName);
          chatAvatar.innerHTML = 'ðŸ”’';
          chatAvatar.style.fontSize = '18px';
          chatTitle.textContent = displayName;
          chatSubtitle.textContent = 'Private room';
          copyBtn.style.display = 'flex';
          copyBtn.onclick = () => {
            navigator.clipboard.writeText(chatId);
            showToast('Room code copied!');
          };
        }
        
        // Subscribe to this chat's room
        subscribeToRoom(chatId, chatId);
      }

      // Render saved messages
      const chat = chats[chatId];
      if (chat && chat.messages) {
        chat.messages.forEach(msg => {
          addMessageToUI(msg.text, msg.sender, msg.sender === currentUser, msg.timestamp, false);
        });
      }

      // Mobile: hide sidebar
      if (window.innerWidth <= 768) {
        document.getElementById('sidebar').classList.add('hidden');
      }
    }

    // Messages
    function addMessageToUI(text, sender, isSelf, timestamp, animate = true) {
      const container = document.getElementById('messagesContainer');

      const msgDiv = document.createElement('div');
      msgDiv.className = 'message' + (isSelf ? ' self' : '');
      if (!animate) msgDiv.style.animation = 'none';
      msgDiv.dataset.sender = sender;

      msgDiv.innerHTML = `
        <div class="message-avatar" style="background: ${getColor(sender)}">${getInitials(sender)}</div>
        <div class="message-content">
          <div class="message-sender">${escapeHtml(sender)}</div>
          <div class="message-bubble">${escapeHtml(text)}</div>
          <div class="message-time">${formatTime(timestamp)}</div>
        </div>
      `;

      container.appendChild(msgDiv);
      container.scrollTop = container.scrollHeight;
    }

    function showSystemMessage(text) {
      const container = document.getElementById('messagesContainer');
      const msgDiv = document.createElement('div');
      msgDiv.className = 'system-message';
      msgDiv.innerHTML = `<span>${escapeHtml(text)}</span>`;
      container.appendChild(msgDiv);
      container.scrollTop = container.scrollHeight;
    }

    function connectToNotificationRoom() {
      notificationRoom = drone.subscribe(`observable-${NOTIFICATION_ROOM}-${currentUser.replace(/\s/g, '_')}`);
      
      notificationRoom.on('data', (data) => {
        if (!data) return;

        if (data.type === 'dm_invitation' && data.to === currentUser) {
          // Check if DM already exists
          const existingDM = findExistingDM(data.from);
          if (existingDM) {
            // Notify sender we already have a DM and switch to it
            sendNotification(data.from, {
              type: 'dm_exists',
              from: currentUser,
              to: data.from,
              roomCode: existingDM
            });
            showToast(`${data.from} tried to DM you - opening existing chat`);
            switchChat(existingDM);
          } else {
            // Show invitation modal
            pendingDMInvite = { from: data.from, roomCode: data.roomCode };
            document.getElementById('dmInviteText').innerHTML = `<strong>${escapeHtml(data.from)}</strong> wants to start a private conversation with you.`;
            showModal('dmInviteModal');
          }
        } else if (data.type === 'dm_accepted' && data.to === currentUser) {
          showToast(`${data.from} accepted your DM`);
          if (!chats[data.roomCode]) {
            chats[data.roomCode] = { type: 'dm', partner: data.from, messages: [] };
            saveChats();
            renderChatList();
          }
          // Subscribe to the DM room
          subscribeToRoom(data.roomCode, data.roomCode);
        } else if (data.type === 'dm_declined' && data.to === currentUser) {
          showToast(`${data.from} declined your DM request`);
        } else if (data.type === 'dm_exists' && data.to === currentUser) {
          showToast(`You already have a DM with ${data.from}`);
          switchChat(data.roomCode);
        } else if (data.type === 'group_invitation' && data.to === currentUser) {
          // Show group invite modal
          pendingGroupInvite = { from: data.from, roomCode: data.roomCode, groupName: data.groupName };
          document.getElementById('groupInviteText').innerHTML = `<strong>${escapeHtml(data.from)}</strong> invited you to join <strong>${escapeHtml(data.groupName)}</strong>`;
          showModal('groupInviteModal');
        } else if (data.type === 'group_accepted' && data.to === currentUser) {
          showToast(`${data.from} joined the group`);
        } else if (data.type === 'group_declined' && data.to === currentUser) {
          showToast(`${data.from} declined the group invite`);
        }
      });
    }

    function sendNotification(targetUser, data) {
      drone.publish({
        room: `observable-${NOTIFICATION_ROOM}-${targetUser.replace(/\s/g, '_')}`,
        message: data
      });
    }

    function sendMessage(text) {
      if (!text.trim()) return;
      
      const timestamp = new Date().toISOString();
      const roomCode = currentChat === 'public' ? PUBLIC_ROOM : currentChat;
      
      drone.publish({
        room: `observable-${roomCode}`,
        message: {
          text: text.trim(),
          name: currentUser,
          timestamp: timestamp
        }
      });
    }

    // DM Functions
    function startDM(targetUser) {
      // Check for existing DM
      const existingDM = findExistingDM(targetUser);
      if (existingDM) {
        showToast(`Opening existing chat with ${targetUser}`);
        switchChat(existingDM);
        return;
      }

      const dmRoomCode = generateCode('dm');
      
      // Create DM locally
      chats[dmRoomCode] = { type: 'dm', partner: targetUser, messages: [] };
      saveChats();
      renderChatList();
      
      // Subscribe to the DM room
      subscribeToRoom(dmRoomCode, dmRoomCode);

      // Send invitation via notification channel
      sendNotification(targetUser, {
        type: 'dm_invitation',
        from: currentUser,
        to: targetUser,
        roomCode: dmRoomCode
      });

      switchChat(dmRoomCode);
      showToast(`DM request sent to ${targetUser}`);
    }

    function acceptDM() {
      closeModal();
      if (!pendingDMInvite) return;

      const { from, roomCode } = pendingDMInvite;

      // Create DM locally
      chats[roomCode] = { type: 'dm', partner: from, messages: [] };
      saveChats();
      renderChatList();
      
      // Subscribe to the DM room
      subscribeToRoom(roomCode, roomCode);

      // Notify sender
      sendNotification(from, {
        type: 'dm_accepted',
        from: currentUser,
        to: from,
        roomCode: roomCode
      });

      switchChat(roomCode);
      pendingDMInvite = null;
    }

    function declineDM() {
      closeModal();
      if (!pendingDMInvite) return;

      sendNotification(pendingDMInvite.from, {
        type: 'dm_declined',
        from: currentUser,
        to: pendingDMInvite.from
      });

      pendingDMInvite = null;
    }

    function renderMemberTags() {
      const container = document.getElementById('memberTags');
      container.innerHTML = '';
      groupInviteMembers.forEach((member, index) => {
        const tag = document.createElement('span');
        tag.className = 'member-tag';
        tag.innerHTML = `${escapeHtml(member)} <button type="button" onclick="removeMember(${index})">&times;</button>`;
        container.appendChild(tag);
      });
    }

    function addMember(name) {
      name = name.trim();
      if (!name || name === currentUser || groupInviteMembers.includes(name)) return;
      groupInviteMembers.push(name);
      renderMemberTags();
    }

    function removeMember(index) {
      groupInviteMembers.splice(index, 1);
      renderMemberTags();
    }

    function createGroup() {
      const name = document.getElementById('groupNameInput').value.trim();
      if (!name) {
        showToast('Please enter a group name');
        return;
      }

      const groupCode = generateCode('group');
      chats[groupCode] = { type: 'group', name: name, messages: [] };
      saveChats();
      renderChatList();
      
      // Subscribe to the group room
      subscribeToRoom(groupCode, groupCode);
      
      // Send invitations to all members
      groupInviteMembers.forEach(member => {
        sendNotification(member, {
          type: 'group_invitation',
          from: currentUser,
          to: member,
          roomCode: groupCode,
          groupName: name
        });
      });

      closeModal();
      document.getElementById('groupNameInput').value = '';
      document.getElementById('memberInput').value = '';
      switchChat(groupCode);
      
      if (groupInviteMembers.length > 0) {
        showToast(`Group created! Invites sent to ${groupInviteMembers.length} user(s)`);
      } else {
        showToast('Group created! Share the code to invite others.');
      }
    }

    function acceptGroupInvite() {
      closeModal();
      if (!pendingGroupInvite) return;

      const { from, roomCode, groupName } = pendingGroupInvite;

      // Create group locally
      chats[roomCode] = { type: 'group', name: groupName, messages: [] };
      saveChats();
      renderChatList();
      
      // Subscribe to the group room
      subscribeToRoom(roomCode, roomCode);

      // Notify sender
      sendNotification(from, {
        type: 'group_accepted',
        from: currentUser,
        to: from,
        roomCode: roomCode
      });

      switchChat(roomCode);
      showToast(`You joined ${groupName}`);
      pendingGroupInvite = null;
    }

    function declineGroupInvite() {
      closeModal();
      if (!pendingGroupInvite) return;

      sendNotification(pendingGroupInvite.from, {
        type: 'group_declined',
        from: currentUser,
        to: pendingGroupInvite.from
      });

      pendingGroupInvite = null;
    }

    // Room Functions
    function createRoom() {
      const name = document.getElementById('roomNameInput').value.trim();
      if (!name) return;

      const roomCode = generateCode('room');
      chats[roomCode] = { type: 'room', name: name, messages: [] };
      saveChats();
      renderChatList();
      
      // Subscribe to the room
      subscribeToRoom(roomCode, roomCode);
      
      closeModal();
      document.getElementById('roomNameInput').value = '';
      switchChat(roomCode);
      showToast('Private room created! Share the code to invite others.');
    }

    function joinRoom() {
      const code = document.getElementById('joinRoomCodeInput').value.trim();
      if (!code) return;

      // Check if already in this chat
      if (chats[code]) {
        switchChat(code);
        closeModal();
        document.getElementById('joinRoomCodeInput').value = '';
        return;
      }

      let chatType = 'room';
      let chatName = 'Private Room';
      if (code.endsWith('_GC')) {
        chatType = 'group';
        chatName = 'Group Chat';
      } else if (code.endsWith('ROOM')) {
        chatType = 'room';
        chatName = 'Private Room';
      }

      chats[code] = { type: chatType, name: chatName, messages: [] };
      saveChats();
      renderChatList();
      
      // Subscribe to the room
      subscribeToRoom(code, code);
      
      closeModal();
      document.getElementById('joinRoomCodeInput').value = '';
      switchChat(code);
    }

    // Show app
    function showChat() {
      document.getElementById('loginScreen').style.display = 'none';
      document.getElementById('chatApp').classList.add('active');
      
      subscribeToRoom(PUBLIC_ROOM, 'public');
      
      // Also subscribe to all saved chats so we receive messages
      Object.keys(chats).forEach(chatId => {
        if (chatId !== 'public') {
          subscribeToRoom(chatId, chatId);
        }
      });
      
      renderChatList();
      switchChat('public');
    }

    // Event Listeners
    document.getElementById('loginForm').addEventListener('submit', (e) => {
      e.preventDefault();
      const name = document.getElementById('usernameInput').value.trim();
      if (!name) return;
      if (/[^a-zA-Z0-9 ]/.test(name)) {
        alert('Name can only contain letters, numbers, and spaces.');
        return;
      }
      currentUser = name;
      localStorage.setItem('vplaza_username', currentUser);
      
      drone = new ScaleDrone(CLIENT_ID);
      drone.on('open', error => {
        if (error) {
          console.error('ScaleDrone error:', error);
          alert('Error connecting to chat server.');
          return;
        }
        connectToNotificationRoom();
        showChat();
      });
    });

    document.getElementById('messageForm').addEventListener('submit', (e) => {
      e.preventDefault();
      const input = document.getElementById('messageInput');
      sendMessage(input.value);
      input.value = '';
    });

    document.getElementById('memberInput').addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        e.preventDefault();
        const input = e.target;
        addMember(input.value);
        input.value = '';
      }
    });

    // Context menu for messages - only show DM option in public chat
    const contextMenu = document.getElementById('contextMenu');
    let contextTarget = null;

    document.getElementById('messagesContainer').addEventListener('contextmenu', (e) => {
      const message = e.target.closest('.message');
      if (!message || message.classList.contains('self')) return;
      
      if (currentChat !== 'public') return;
      
      e.preventDefault();
      const sender = message.dataset.sender;
      if (!sender || sender === currentUser) return;

      contextTarget = sender;
      
      let x = e.pageX;
      let y = e.pageY;
      if (x + 180 > window.innerWidth) x = window.innerWidth - 190;
      if (y + 50 > window.innerHeight) y = window.innerHeight - 60;
      
      contextMenu.style.left = x + 'px';
      contextMenu.style.top = y + 'px';
      contextMenu.classList.add('show');
    });

    document.getElementById('dmMenuItem').addEventListener('click', () => {
      if (contextTarget) {
        startDM(contextTarget);
        contextTarget = null;
      }
      contextMenu.classList.remove('show');
    });

    document.getElementById('renameChatItem').addEventListener('click', renameChat);
    document.getElementById('leaveChatItem').addEventListener('click', leaveChat);
    document.getElementById('renameChatConfirm').addEventListener('click', confirmRenameChat);

    document.addEventListener('click', (e) => {
      if (!contextMenu.contains(e.target)) {
        contextMenu.classList.remove('show');
      }
      const chatContextMenu = document.getElementById('chatContextMenu');
      if (!chatContextMenu.contains(e.target)) {
        chatContextMenu.classList.remove('show');
      }
    });

    // Modal buttons
    document.getElementById('modalOverlay').addEventListener('click', closeModal);
    document.getElementById('newGroupBtn').addEventListener('click', () => showModal('createGroupModal'));
    document.getElementById('newRoomBtn').addEventListener('click', () => showModal('createRoomModal'));
    document.getElementById('joinRoomBtn').addEventListener('click', () => showModal('joinRoomModal'));
    document.getElementById('createGroupConfirm').addEventListener('click', createGroup);
    document.getElementById('createRoomConfirm').addEventListener('click', createRoom);
    document.getElementById('joinRoomConfirm').addEventListener('click', joinRoom);
    document.getElementById('dmAcceptBtn').addEventListener('click', acceptDM);
    document.getElementById('dmDeclineBtn').addEventListener('click', declineDM);
    document.getElementById('groupAcceptBtn').addEventListener('click', acceptGroupInvite);
    document.getElementById('groupDeclineBtn').addEventListener('click', declineGroupInvite);

    // Mobile back button
    document.getElementById('backBtn').addEventListener('click', () => {
      document.getElementById('sidebar').classList.remove('hidden');
    });

    // Initialize
    loadChats();
    const savedUser = localStorage.getItem('vplaza_username');
    if (savedUser) {
      currentUser = savedUser;
      drone = new ScaleDrone(CLIENT_ID);
      drone.on('open', error => {
        if (error) {
          console.error('ScaleDrone error:', error);
          return;
        }
        connectToNotificationRoom();
        showChat();
      });
    }
  </script>
</body>
</html>
